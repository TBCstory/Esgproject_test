generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  PM
  AUTHOR
  REVIEWER
  APPROVER
  AUDITOR
}

enum ReportStatus {
  DRAFT
  IN_REVIEW
  REVISION_REQUESTED
  APPROVED
  PUBLISHED
}

enum SectionStatus {
  DRAFT
  IN_REVIEW
  REVISION_REQUESTED
  APPROVED
}

enum TargetType {
  SECTION
  KPI
  TABLE
  REQUIREMENT
}

enum LinkType {
  SECTION
  KPI
  REQUIREMENT
}

enum CoverageStatus {
  UNMAPPED
  MAPPED
  NEEDS_EVIDENCE
  COMPLETE
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

model Organization {
  id         String       @id @default(uuid())
  name       String
  slug       String       @unique
  createdAt  DateTime     @default(now())
  users      User[]
  projects   Project[]
  evidence   EvidenceFile[]
  kpis       KpiCatalog[]
  orgUnits   OrgUnit[]
}

model User {
  id         String        @id @default(uuid())
  email      String        @unique
  name       String?
  role       Role          @default(AUTHOR)
  orgId      String
  org        Organization  @relation(fields: [orgId], references: [id])
  createdAt  DateTime      @default(now())
  comments   Comment[]
  tasks      Task[]
  versions   ReportVersion[]
  evidenceUploads EvidenceFile[] @relation("EvidenceUploads")
}

model Project {
  id                 String    @id @default(uuid())
  orgId              String
  org                Organization @relation(fields: [orgId], references: [id])
  name               String
  year               Int
  frameworksSelected String[]
  reports            Report[]
  kpiValues          KpiValue[]
  createdAt          DateTime  @default(now())
}

model Report {
  id        String        @id @default(uuid())
  projectId String
  project   Project       @relation(fields: [projectId], references: [id])
  title     String
  status    ReportStatus  @default(DRAFT)
  versions  ReportVersion[]
  sections  Section[]
  createdAt DateTime      @default(now())
}

model ReportVersion {
  id          String     @id @default(uuid())
  reportId    String
  report      Report     @relation(fields: [reportId], references: [id])
  versionNo   Int
  createdById String?
  createdBy   User?      @relation(fields: [createdById], references: [id])
  frozenAt    DateTime?
  isCurrent   Boolean    @default(true)
  contents    SectionContent[]
  createdAt   DateTime   @default(now())
}

model Section {
  id              String        @id @default(uuid())
  reportId        String
  report          Report        @relation(fields: [reportId], references: [id])
  parentSectionId String?
  parent          Section?      @relation("SectionTree", fields: [parentSectionId], references: [id])
  children        Section[]     @relation("SectionTree")
  order           Int           @default(0)
  title           String
  type            String
  status          SectionStatus @default(DRAFT)
  contents        SectionContent[]
  createdAt       DateTime      @default(now())
}

model SectionContent {
  id              String        @id @default(uuid())
  sectionId       String
  section         Section       @relation(fields: [sectionId], references: [id])
  versionId       String
  version         ReportVersion @relation(fields: [versionId], references: [id])
  contentMd       String?
  contentRichtext String?
  status          SectionStatus @default(DRAFT)
  updatedAt       DateTime      @updatedAt

  @@unique([sectionId, versionId])
}

model KpiCatalog {
  id         String       @id @default(uuid())
  orgId      String
  org        Organization @relation(fields: [orgId], references: [id])
  code       String
  name       String
  definition String?
  unit       String?
  formula    String?
  boundary   String?
  dataOwner  String?
  values     KpiValue[]
  createdAt  DateTime     @default(now())

  @@unique([orgId, code])
}

model OrgUnit {
  id        String    @id @default(uuid())
  orgId     String
  org       Organization @relation(fields: [orgId], references: [id])
  name      String
  parentId  String?
  parent    OrgUnit?  @relation("OrgTree", fields: [parentId], references: [id])
  children  OrgUnit[] @relation("OrgTree")
  kpiValues KpiValue[]
}

model KpiValue {
  id        String     @id @default(uuid())
  kpiId     String
  kpi       KpiCatalog @relation(fields: [kpiId], references: [id])
  projectId String
  project   Project    @relation(fields: [projectId], references: [id])
  period    String
  orgUnitId String?
  orgUnit   OrgUnit?   @relation(fields: [orgUnitId], references: [id])
  value     Float
  note      String?
  sourceRef String?
  createdAt DateTime   @default(now())
}

model Framework {
  id          String        @id @default(uuid())
  name        String
  version     String?
  requirements Requirement[]
  createdAt   DateTime      @default(now())

  @@unique([name, version])
}

model Requirement {
  id          String     @id @default(uuid())
  frameworkId String
  framework   Framework  @relation(fields: [frameworkId], references: [id])
  code        String
  title       String
  text        String?
  tags        String[]
  datapoints  Datapoint[]
  mappings    Mapping[]
  createdAt   DateTime   @default(now())

  @@unique([frameworkId, code])
}

model Datapoint {
  id             String      @id @default(uuid())
  requirementId  String
  requirement    Requirement @relation(fields: [requirementId], references: [id])
  code           String
  description    String?
  mandatoryLevel String?
  mappings       Mapping[]
}

model Mapping {
  id             String        @id @default(uuid())
  targetType     TargetType
  targetId       String
  requirementId  String
  requirement    Requirement   @relation(fields: [requirementId], references: [id])
  datapointId    String?
  datapoint      Datapoint?     @relation(fields: [datapointId], references: [id])
  coverageStatus CoverageStatus @default(UNMAPPED)
  createdAt      DateTime      @default(now())
}

model EvidenceFile {
  id          String    @id @default(uuid())
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id])
  storageKey  String
  filename    String
  mime        String?
  uploadedById String?
  uploadedBy  User?     @relation("EvidenceUploads", fields: [uploadedById], references: [id])
  issuedBy    String?
  validFrom   DateTime?
  validTo     DateTime?
  links       EvidenceLink[]
  createdAt   DateTime  @default(now())
}

model EvidenceLink {
  id         String    @id @default(uuid())
  evidenceId String
  evidence   EvidenceFile @relation(fields: [evidenceId], references: [id])
  linkType   LinkType
  linkId     String
  note       String?
  pageRange  String?
  createdAt  DateTime  @default(now())
}

model CommentThread {
  id         String    @id @default(uuid())
  targetType TargetType
  targetId   String
  comments   Comment[]
  createdAt  DateTime  @default(now())
}

model Comment {
  id        String    @id @default(uuid())
  threadId  String
  thread    CommentThread @relation(fields: [threadId], references: [id])
  authorId  String?
  author    User?     @relation(fields: [authorId], references: [id])
  body      String
  resolvedAt DateTime?
  createdAt DateTime  @default(now())
}

model Task {
  id         String    @id @default(uuid())
  assigneeId String?
  assignee   User?     @relation(fields: [assigneeId], references: [id])
  targetType TargetType
  targetId   String
  priority   TaskPriority @default(MEDIUM)
  dueDate    DateTime?
  status     TaskStatus   @default(OPEN)
  createdAt  DateTime     @default(now())
}
